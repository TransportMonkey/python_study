## 一、数据库事务处理

是一组操作集合，事务会把所有的操作作为一个整体一起向系统提交或撤销操作请求，这些操作要么同时成功。要么同时失败。

### 事务的四大特性（ACID）

- 原子性：要么成功，要么失败；
- 一致性：事务完成时，必须使所有的数据都保持一致状态；
- 隔离性：保证事务在不受外部并发操作影响的独立；
- 持久性：事务一旦提交或回滚，它对数据库的数据改变就是永久的

### 自动提交事务(MySQL默认是开启)

```sql
set @@aotucommit=1 
```

### 手动提交事务

```sql
set @@autocommit=0 # 设置事务不要自动提交
start transaction # 开启事务
commit # 提交事务
```

## 二、sqlite3模块

是Python的标准库，方便地创建、查询和管理 SQLite 数据库。

- 连接数据库

```sqlite
conn = sqlite3.connect('example.db')  # 连接到数据库文件 example.db,没有该db文件，则新建文件；内存数据库(:memory:)
```

- 创建表格

```sqlit
create table 表格名(
		列名1 数据类型 主键(默认),
		列名2 数据类型 not null,
		.....
	);
```

- 插入数据

```sqlite
insert into 表格（字段1,字段2,...）values(数据1,数据2,...);
```

- 查询数据

```sqlite
select * from 表格;
```

- 更新数据

```sqlite
update 表格 set 字段 = 新的值;
```

- 删除数据

```sqlite
delete from 表格 where 字段;
```

- 执行单条SQL语句

```sqlite
游标.execute(sql语句,(数据,))
```

- 执行多条SQL语句

```sqlite
游标.executemany(sql语句,(数据,),(数据,))
```

- 提交事务

```sqlite
数据连接对象.commit()
```

- 关闭游标&连接

```sqlite
游标.close()
数据连接对象.close()
```

## 三、理解ORM的概念

​	是一种对象关系映射技术，用于在关系型数据库和面向对象编程语言之间建立桥梁，实现数据模型与数据库标的双向映射。

###  映射关系

- **类 ↔ 表**：一个类对应数据库中的一张表
- **属性 ↔ 列**：类的属性对应表的列
- **对象 ↔ 行**：类的实例对应表中的一行数据
- **关系 ↔ 外键**：类之间的关系对应表之间的外键约束

### 优缺点

- 优点：
  - 提高开发效率，降低开发成本
  - 使开发更加对象化
  - 具有可移植性
  - 可以很方便的引用数据库，缓存之类的附加功能
- 缺点：
  - 在处理多表联查，where条件复杂之类的查询时，orm的语法会变得复杂，需要写入原生的SQL语句

### 一对多示例

```python
from sqlalchemy import create_engine, Column, Integer, String, Float
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import sessionmaker,relationship
from typing import Dict

# 创建数据库引擎
engine = create_engine('sqlite:///products.db', echo=False)
Base = declarative_base()
# 手动创建表
# Base.metadata.create_all(engine)
# # 创建会话
Session = sessionmaker(bind=engine)
session = Session()

class BaseMy(Base):
    __abstract__ = True
    def to_dict(self,includes:list=None,excludes:list=None) -> Dict:
        if includes: # 按指定的字段名去获取数据
            return {k: v for k, v in self.__dict__.items() if not k.startswith('_') and k in includes}
        return {k: v for k, v in self.__dict__.items() if not k.startswith('_')}


# 一对多关系
# 定义 users 模型
class User(BaseMy):
    __tablename__ = 'user'
    id = Column(Integer, primary_key=True, autoincrement=True)
    name = Column(String, nullable=False)
    # todo_id = Column(Integer)
    todos = relationship(
        'UserTodo',
        primaryjoin='User.id==foreign(UserTodo.user_id)',
        uselist=True,
    )

# 定义todo模型
class UserTodo(BaseMy):
    __tablename__ = 'user_todo'
    id = Column(Integer, primary_key=True, autoincrement=True)
    name = Column(String, nullable=False)
    user_id = Column(Integer) # 外键
    user = relationship(
        'User',
        primaryjoin='User.id==foreign(UserTodo.user_id)',
        uselist=False,
    )

users = session.query(User).all()
for user in users:
    print(f'{user.name}: {[todo.name for todo in user.todos]}')

```

## 四、API

是“应用程序编程接口”的英文缩写，它是一种软件组件之间进行交互的接口。

RESTful API(REST是一种软件架构风格)

### HTTP方法

- **GET**：用于查询资源。例如，获取用户信息、获取订单列表等。
- **POST**：用于创建资源。例如，创建新用户、提交新订单等。
- **PUT**：用于完全更新资源。例如，更新用户信息、更新订单状态等。
- **PATCH**：用于部分更新资源。例如，只更新用户的部分信息（如邮箱）。
- **DELETE**：用于删除资源。例如，删除用户、删除订单等。

### **资源标识符（URI）**

- `/users`：表示用户集合。
- `/users/{id}`：表示特定用户，其中 `{id}` 是用户 ID 的占位符。
- `/orders`：表示订单集合。
- `/orders/{id}`：表示特定订单。